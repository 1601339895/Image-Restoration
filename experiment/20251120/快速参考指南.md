# å¿«é€Ÿå‚è€ƒæŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1åˆ†é’Ÿä¸Šæ‰‹
```python
import torch
from FPN_Restormer_CA_CNN_Encoder import Restormer_FFT_DSConv_Fusion

# åˆ›å»ºPAFPNæ¨¡å‹ï¼ˆæ¨èï¼‰
model = Restormer_FFT_DSConv_Fusion(
    inp_channels=3,
    out_channels=3,
    dim=48,
    fusion_type='PAFPN'  # å¯é€‰ï¼š'None', 'FPN', 'PAFPN'
).cuda()

# å‰å‘ä¼ æ’­
img = torch.randn(1, 3, 256, 256).cuda()
output = model(img)
print(output.shape)  # torch.Size([1, 3, 256, 256])
```

---

## ğŸ“‹ å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|-------|-----|
| inp_channels | 3 | è¾“å…¥å›¾åƒé€šé“æ•° |
| out_channels | 3 | è¾“å‡ºå›¾åƒé€šé“æ•° |
| dim | 48 | åŸºç¡€é€šé“æ•° |
| num_blocks | [4,6,6,8] | å„å±‚Blockæ•°é‡ |
| fusion_type | 'PAFPN' | èåˆç±»å‹ |
| heads | [1,2,4,8] | æ³¨æ„åŠ›å¤´æ•° |
| bias | False | æ˜¯å¦ä½¿ç”¨åç½® |

---

## ğŸ¯ èåˆç±»å‹é€‰æ‹©

### Noneï¼ˆæ— èåˆï¼‰
```python
model = Restormer_FFT_DSConv_Fusion(fusion_type='None')
```
- âœ… æœ€å¿«é€Ÿåº¦
- âœ… æœ€å°‘å‚æ•°
- âŒ æ•ˆæœä¸€èˆ¬
- ğŸ’¡ **ç”¨é€”**ï¼šåŸºçº¿å¯¹æ¯”

### FPNï¼ˆå•å‘èåˆï¼‰
```python
model = Restormer_FFT_DSConv_Fusion(fusion_type='FPN')
```
- âœ… é€Ÿåº¦è¾ƒå¿«
- âœ… å‚æ•°é€‚ä¸­
- âœ… æ•ˆæœè¾ƒå¥½
- ğŸ’¡ **ç”¨é€”**ï¼šé€Ÿåº¦ä¸æ•ˆæœå¹³è¡¡

### PAFPNï¼ˆåŒå‘èåˆï¼Œæ¨èï¼‰
```python
model = Restormer_FFT_DSConv_Fusion(fusion_type='PAFPN')
```
- âœ… æœ€ä½³æ•ˆæœ
- âœ… åŒå‘ä¿¡æ¯æµ
- âš ï¸ å‚æ•°ç¨å¤š
- ğŸ’¡ **ç”¨é€”**ï¼šè¿½æ±‚æœ€ä½³æ€§èƒ½

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ç»´åº¦ä¸åŒ¹é…é”™è¯¯ï¼Ÿ
**A**: å·²ä¿®å¤ï¼ç¡®ä¿ä½¿ç”¨ä¿®æ”¹åçš„ä»£ç ã€‚

### Q2: è¾“å…¥å°ºå¯¸è¦æ±‚ï¼Ÿ
**A**: å¿…é¡»èƒ½è¢«8æ•´é™¤ï¼Œå¦‚ï¼š256Ã—256, 512Ã—512

### Q3: å¦‚ä½•é€‰æ‹©èåˆç±»å‹ï¼Ÿ
**A**:
- å¿«é€Ÿæµ‹è¯• â†’ None
- å¸¸è§„è®­ç»ƒ â†’ FPN
- æœ€ä½³æ•ˆæœ â†’ PAFPN

### Q4: å†…å­˜ä¸å¤Ÿæ€ä¹ˆåŠï¼Ÿ
**A**:
1. å‡å°æ‰¹æ¬¡å¤§å°
2. é™ä½dimå‚æ•°ï¼ˆ48â†’32ï¼‰
3. é€‰æ‹©FPNä»£æ›¿PAFPN

---

## ğŸ“Š æ€§èƒ½åŸºå‡†

### è¾“å…¥ï¼š256Ã—256Ã—3
| æ¨¡å‹ | å‚æ•°é‡ | æ¨ç†æ—¶é—´ | æ˜¾å­˜å ç”¨ |
|-----|-------|---------|--------|
| None | ~15M | åŸºå‡† | åŸºå‡† |
| FPN | ~16M | +5% | +3% |
| PAFPN | ~17M | +10% | +5% |

*å…·ä½“æ•°å€¼å–å†³äºç¡¬ä»¶é…ç½®*

---

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§

### éªŒè¯æ¨¡å‹
```python
# æµ‹è¯•å•å¼ å›¾åƒ
img = torch.randn(1, 3, 256, 256).cuda()
with torch.no_grad():
    out = model(img)
print(f"è¾“å…¥: {img.shape}")
print(f"è¾“å‡º: {out.shape}")
print(f"å‚æ•°é‡: {sum(p.numel() for p in model.parameters())/1e6:.2f}M")
```

### æŸ¥çœ‹ç‰¹å¾ç»´åº¦
```python
# åœ¨forwardä¸­æ·»åŠ æ‰“å°
def forward(self, inp_img):
    out_enc_level1 = self.encoder_level1(inp_enc_level1)
    print(f"Level1: {out_enc_level1.shape}")
    # ... å…¶ä»–å±‚ç±»ä¼¼
```

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

| æ–‡æ¡£ | å†…å®¹ |
|-----|-----|
| ä¿®å¤è¯´æ˜.md | è¯¦ç»†ä¿®å¤è¿‡ç¨‹ |
| ä»£ç ä¿®æ”¹å¯¹æ¯”.md | ä¿®æ”¹å‰åå¯¹æ¯” |
| test_fpn_dimensions.py | ç»´åº¦æµ‹è¯• |
| ç‰¹å¾æµè½¬å¯è§†åŒ–.py | æµç¨‹å¯è§†åŒ– |
| README_ä¿®æ”¹å®Œæˆ.md | å®Œæ•´è¯´æ˜ |
| å¿«é€Ÿå‚è€ƒæŒ‡å—.md | æœ¬æ–‡æ¡£ |

---

## âš¡ è®­ç»ƒå»ºè®®

### åŸºç¡€é…ç½®
```python
# ä¼˜åŒ–å™¨
optimizer = torch.optim.AdamW(
    model.parameters(),
    lr=3e-4,
    betas=(0.9, 0.999),
    weight_decay=1e-4
)

# å­¦ä¹ ç‡è°ƒåº¦
scheduler = torch.optim.lr_scheduler.CosineAnnealingLR(
    optimizer,
    T_max=epochs
)

# æŸå¤±å‡½æ•°
criterion = torch.nn.L1Loss()  # æˆ– MSELoss, CharbonnierLoss
```

### æ•°æ®å¢å¼º
```python
import torchvision.transforms as T

transform = T.Compose([
    T.RandomHorizontalFlip(),
    T.RandomVerticalFlip(),
    T.RandomRotation(90),
])
```

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **é¢„è®­ç»ƒ**ï¼šå…ˆåœ¨å¤§æ•°æ®é›†ä¸Šé¢„è®­ç»ƒ
2. **å¾®è°ƒ**ï¼šåœ¨ç›®æ ‡æ•°æ®é›†ä¸Šfine-tune
3. **æ··åˆç²¾åº¦**ï¼šä½¿ç”¨torch.cuda.ampåŠ é€Ÿ
4. **æ¢¯åº¦è£å‰ª**ï¼šé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
5. **å®šæœŸéªŒè¯**ï¼šæ¯Nä¸ªepochä¿å­˜checkpoint

---

## ğŸ“– ä»£ç ç‰‡æ®µ

### å®Œæ•´è®­ç»ƒå¾ªç¯
```python
for epoch in range(epochs):
    model.train()
    for batch in train_loader:
        img, target = batch
        img, target = img.cuda(), target.cuda()

        # å‰å‘ä¼ æ’­
        output = model(img)
        loss = criterion(output, target)

        # åå‘ä¼ æ’­
        optimizer.zero_grad()
        loss.backward()
        optimizer.step()

    scheduler.step()

    # éªŒè¯
    if epoch % 10 == 0:
        model.eval()
        with torch.no_grad():
            # éªŒè¯ä»£ç 
            pass
```

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] PyTorchå·²å®‰è£…
- [ ] CUDAå¯ç”¨ï¼ˆæ¨èï¼‰
- [ ] è¾“å…¥å°ºå¯¸èƒ½è¢«8æ•´é™¤
- [ ] é€‰æ‹©åˆé€‚çš„fusion_type
- [ ] éªŒè¯è¾“å‡ºç»´åº¦æ­£ç¡®
- [ ] å‚æ•°é‡ç¬¦åˆé¢„æœŸ

---

**ç¥è®­ç»ƒé¡ºåˆ©ï¼ğŸ‰**
